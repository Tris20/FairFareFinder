<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Histogram + Slider with Interval Labels</title>
    <style>
      /* Container for chart + slider */
      #chart-container {
        position: relative;
        width: 600px;
        height: 300px;
        margin: 20px auto;
        border: 1px solid #ccc;
      }

      /* Bar chart area */
      #chart {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 80%;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        padding: 0 5px;
      }

      /* Each bin's outer bar (represents total count in that bin) */
      .bar {
        position: relative;
        width: 100%;
        background-color: lightgray; /* total distribution color */
        display: flex;
        align-items: flex-end;
        justify-content: center;
        margin: 0 1px;
      }

      /* The nested portion that shows how many items pass the filter. */
      .included-portion {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: steelblue;
      }

      /* Label that sits above the bar, showing the bin interval */
      .bar-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        text-align: center;
        font-size: 12px;
        color: #333;
        transform: translateY(-100%); /* place label just above the bar */
        pointer-events: none;
      }

      /* Range slider on top of chart */
      #value-slider {
        position: absolute;
        top: 0; /* or bottom: 0 if you prefer */
        left: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="chart-container">
      <div id="chart"></div>
      <!-- Continuous range slider. We'll set its min/max in JS after CSV load. -->
      <input
        type="range"
        id="value-slider"
        min="0"
        max="100"
        step="1"
        value="50"
        oninput="onSliderChange(this.value)"
      />
    </div>

    <script>
      // Configurable bin count
      const BIN_COUNT = 10;

      let dataValues = [];
      let globalMin = 0;
      let globalMax = 100;

      // Fetch + parse CSV
      // Make sure 'dummy.csv' is in the same folder (and has a header row "value").
      fetch("dummy.csv")
        .then((response) => response.text())
        .then((csvText) => {
          const lines = csvText.trim().split("\n");
          // Remove header
          lines.shift(); // assuming first line is 'value'
          dataValues = lines
            .map((line) => parseFloat(line.trim()))
            .filter((v) => !isNaN(v));

          // Compute global min/max
          globalMin = Math.min(...dataValues);
          globalMax = Math.max(...dataValues);

          // Initialize slider
          const slider = document.getElementById("value-slider");
          slider.min = globalMin;
          slider.max = globalMax;
          slider.value = globalMax; // default to max

          // Draw the full distribution initially
          drawHistogram(
            dataValues,
            parseFloat(slider.value),
            globalMin,
            globalMax,
            BIN_COUNT,
          );
        })
        .catch((err) => console.error("Error fetching CSV:", err));

      /**
       * Always display the TOTAL distribution across bins
       * plus a nested overlay for how many items pass "filterValue".
       *
       * @param {number[]} values   - All data values.
       * @param {number} filterVal  - The current slider value (e.g. we keep items <= filterVal).
       * @param {number} minVal     - The min value in the dataset.
       * @param {number} maxVal     - The max value in the dataset.
       * @param {number} binCount   - How many bins to create.
       */
      function drawHistogram(values, filterVal, minVal, maxVal, binCount) {
        const chart = document.getElementById("chart");
        chart.innerHTML = "";

        if (values.length === 0) {
          chart.textContent = "No data found";
          return;
        }

        const range = maxVal - minVal;
        const binSize = range / binCount;

        // Prepare bins: each bin tracks { total, included }
        let bins = Array.from({ length: binCount }, () => ({
          total: 0,
          included: 0,
        }));

        // Populate bins
        values.forEach((v) => {
          let idx = Math.floor((v - minVal) / binSize);
          if (idx < 0) idx = 0;
          if (idx >= binCount) idx = binCount - 1;

          bins[idx].total += 1;
          // If v passes the filter (<= filterVal), count it as included
          if (v <= filterVal) {
            bins[idx].included += 1;
          }
        });

        // Find the maximum total count among bins (for vertical scaling)
        const maxCount = Math.max(...bins.map((b) => b.total));

        // Generate DOM elements for each bin
        bins.forEach((bin, i) => {
          // The start and end of this bin's interval
          const binStart = minVal + i * binSize;
          const binEnd = minVal + (i + 1) * binSize;

          // Create the outer bar
          const barWrapper = document.createElement("div");
          barWrapper.className = "bar";

          // Outer bar height = (bin.total / maxCount) * 100%
          const totalPercent = (bin.total / maxCount) * 100;
          barWrapper.style.height = totalPercent + "%";

          // Create a nested bar showing how many items pass the filter
          if (bin.total > 0) {
            const includedPercent = (bin.included / bin.total) * 100;
            const includedDiv = document.createElement("div");
            includedDiv.className = "included-portion";
            includedDiv.style.height = includedPercent + "%";
            barWrapper.appendChild(includedDiv);
          }

          // Label for the bin's interval
          const label = document.createElement("div");
          label.className = "bar-label";
          // Format intervals however you like; here, just rounding to 1 decimal
          label.textContent = `${binStart.toFixed(1)} - ${binEnd.toFixed(1)}`;
          barWrapper.appendChild(label);

          chart.appendChild(barWrapper);
        });
      }

      // Called whenever the slider changes
      function onSliderChange(sliderValue) {
        const filterVal = parseFloat(sliderValue);
        drawHistogram(dataValues, filterVal, globalMin, globalMax, BIN_COUNT);
      }
    </script>
  </body>
</html>
