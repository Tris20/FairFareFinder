<!doctype html>
<html lang="en">
  <head>
    {{ template "seo.html" }}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>fairfarefinder</title>

    <!-- Link to the CSS files located in the 'css' folder -->
    <link rel="stylesheet" href="/css/resetCSS.css" />
    <link rel="stylesheet" href="/css/htmxFilter.css" />
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/tableStyles.css" />
    <link rel="stylesheet" href="/css/mobileStyles.css" />
    <link rel="stylesheet" href="/css/formStyles.css" />
    <link rel="stylesheet" href="/css/modal.css" />
    <link rel="stylesheet" href="/css/search.css" />
    <!-- Add Google Fonts for Dosis -->
    <link
      href="https://fonts.googleapis.com/css2?family=Dosis:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    <script src="https://unpkg.com/htmx.org"></script>
  </head>

  <div id="page-banner">
    <div class="banner-content">
      <img src="/images/favicon_orange_turq.ico" alt="FFF Icon" id="fff-icon" />
      <h2>
        <span><span class="first-letter">f</span>air</span>
        <span><span class="first-letter">f</span>are</span>
        <span><span class="first-letter">f</span>inder</span>
      </h2>
    </div>
  </div>

  <body>
    <!-- Background image div -->
    <div id="bg-image-dreams"></div>

    <!-- Initial website name that will fade in and out -->
    <div
      id="website-name"
      class="fade-in"
      style="font-family: &quot;Dosis&quot;, sans-serif"
    >
      fair fare finder
    </div>
    <!-- Header that will appear above the form -->

    <!-- Table content container that will appear after the text fades out -->
    <!-- Banner structure -->
    <div id="table-container">
      <div class="scroll-container">
        <form
          id="flight-form"
          hx-get="/filter"
          hx-target="#flight-table"
          hx-trigger="change, input delay:50ms"
        >
          <!-- Dynamic city input rows -->
          <div id="city-rows" style="width: 100%">
            <div class="form-group city-row">
              <label for="city-search">From:</label>

              <div class="dropdown-container">
                <input
                  id="city-search"
                  class="dropdown-input"
                  name="city[]"
                  placeholder="Search for a city"
                  autocomplete="off"
                />
                <button id="dropdown-btn" class="dropdown-btn" type="button">
                  <span class="caret">▼</span>
                </button>
                <ul id="city-list" class="dropdown-list hidden"></ul>
              </div>
              <label for="priceOutput0">Flights</label>
              <output id="priceOutput0" class="output-range">€399.00</output>
              <input
                type="range"
                id="combinedPrice-slider0"
                name="maxPriceLinear[]"
                min="0"
                max="100"
                step="1"
                value="49"
                class="price-slider"
                hx-get="/update-slider-price"
                hx-target="#priceOutput0"
                hx-trigger="input"
                hx-push-url="false"
                hx-preserve="false"
                hx-include="#combinedPrice-slider0"
                autocomplete="off"
              />
            </div>
          </div>
          <!-- Button to add more origin cities -->

          <div class="form-group">
            <button type="button" id="add-city-button">Add Another City</button>
          </div>

          <div class="form-group">
            <label for="accommodationOutput0">Avg. Hotel Price PPPN:</label>
            <output id="accommodationOutput0" class="output-range"
              >€99.00</output
            >
            <input
              type="range"
              id="accommodationPrice-slider0"
              name="maxAccommodationPrice[]"
              min="0"
              max="100"
              step="1"
              value="35"
              class="price-slider"
              hx-get="/update-slider-price"
              hx-target="#accommodationOutput0"
              hx-trigger="input"
              hx-push-url="false"
              hx-preserve="false"
              hx-include="#accommodationPrice-slider0"
              autocomplete="off"
            />
          </div>

          <div class="form-group">
            <label for="sort">Sort By:</label>
            <select id="sort" name="sort">
              <option value="best_weather" selected>
                Sunniest and Warmest
              </option>
              <option value="cheapest_hotel">Cheapest Hotel Price</option>
              <option value="shortest_flight">Shortest Flight</option>
              <option value="worst_weather">Coldest and Wettest</option>
              <option value="most_expensive_hotel">
                Most Expensive Hotel Price
              </option>

              <option value="longest_flight">Longest Flight</option>
              <!--<option value="low_price">Most Affordable</option>
            <option value="high_price">Most Expensive</option>-->
            </select>
          </div>
        </form>

        <div id="flight-table">
          <!-- The cards will be dynamically updated here -->
        </div>

        <footer id="footer-privacy">
          <p>
            &copy; 2024 FairFareFinder |
            <a href="/privacy-policy">Privacy Policy</a>
          </p>
        </footer>
      </div>
    </div>

    <script>
      let cities = [];
      let hasFadedIn = false; // Flag to check if the table has already faded in
      let additionalCityCount = 0;
      document.addEventListener("DOMContentLoaded", function () {
        // After the fade-out animation ends, hide the website-name and show the table
        setTimeout(function () {
          document.getElementById("website-name").style.display = "none";

          // Show the table content with the fade-in animation and move it up
          const tableContainer = document.getElementById("table-container");
          tableContainer.classList.add("show");

          // Also show the header and move it with the form
          const pageHeader = document.getElementById("page-banner");
          pageHeader.classList.add("show");

          // Wait for the 'moveUp' animation to finish (animationend event)
          tableContainer.addEventListener("animationend", function (event) {
            if (event.animationName === "moveUp") {
              // Manually trigger the form submission after the animation is complete
              htmx.trigger("#flight-form", "change");
            }
          });

          // Handle HTMX table swap event for the first time only
          document
            .getElementById("flight-table")
            .addEventListener("htmx:afterSwap", function () {
              if (!hasFadedIn) {
                const flightTable = document.getElementById("flight-table");
                flightTable.classList.add("fade-in");
                hasFadedIn = true;

                // Show the footer after the table has been loaded
                const footer = document.querySelector("#footer-privacy");
                footer.classList.add("fade-in");
              }
            });

          // Show the background image with a fade-in effect
          document.getElementById("bg-image-dreams").style.opacity = "1";
        }, 2000);
      });

      document
        .getElementById("city-rows")
        .addEventListener("click", function (event) {
          if (event.target.classList.contains("remove-city-button")) {
            const cityRow = event.target.closest(".city-row");
            cityRow.remove();
            additionalCityCount--;
            toggleDurationVisibility();
          }
        });

      // Add event listener for adding additional cities dynamically

      let rowCount = 1;

      document
        .getElementById("add-city-button")
        .addEventListener("click", function () {
          const cityRows = document.getElementById("city-rows");
          const div = document.createElement("div");
          div.className = "form-group city-row";
          div.innerHTML = `
                                   <button type="button" class="remove-city-button">-</button>
                                          <select name="logical_operator[]">
                                            <option value="AND">AND</option>
                                            <option value="OR">OR</option>
                                          </select>
                                          <label>City:</label>
      <div class="dropdown-container">
                      <input
                        id="city-search"
                        class="dropdown-input"
                        name="city[]"
                        placeholder="Search for a city"
                        autocomplete="off"
                      />
                      <button class="dropdown-btn" type="button">
                        <span class="caret">▼</span>
                      </button>
                      <ul class="dropdown-list hidden"></ul>
                    </div>

                                          <label for="priceOutput${rowCount}"></label>
                                          <output id="priceOutput${rowCount}" class="output-range">€399.00</output>
                                          <input
                                            type="range"
                                            id="combinedPrice-slider${rowCount}"
                                            name="maxPriceLinear[]"
                                            min="0"
                                            max="100"
                                            step="1"
                                            value="49"
                                            class="price-slider"
                                            hx-get="/update-slider-price"
                                            hx-target="#priceOutput${rowCount}"
                                            hx-trigger="input"
                                            hx-push-url="false"
                                            hx-preserve="false"
                                            hx-include="#combinedPrice-slider${rowCount}"
                                            autocomplete="off"
                                          />

                                        `;
          cityRows.appendChild(div);
          htmx.process(div);
          rowCount++;
          // Initialize dropdown for the new input
          const input = div.querySelector(".dropdown-input");
          const dropdown = div.querySelector(".dropdown-list");
          const button = div.querySelector(".dropdown-btn");

          // Reuse the dropdown logic for the new city input
          let highlightedIndex = -1;

          function populateDropdown(filteredCities) {
            dropdown.innerHTML = ""; // Clear current list
            filteredCities.forEach(({ city, country }, index) => {
              const li = document.createElement("li");
              li.textContent = `${city}`;
              li.classList.add("dropdown-item");

              // Highlight the item if it matches the current index
              if (index === highlightedIndex) {
                li.classList.add("highlighted");
              }

              li.addEventListener("click", () => {
                input.value = li.textContent; // Set input value
                dropdown.classList.add("hidden"); // Hide dropdown

                // Trigger HTMX-compatible "change" event
                input.dispatchEvent(new Event("change", { bubbles: true }));
              });

              dropdown.appendChild(li);
            });
          }

          input.addEventListener("input", () => {
            const value = input.value.toLowerCase();
            const filteredCities = cities.filter(({ city, country }) =>
              `${city}, ${country}`.toLowerCase().includes(value),
            );
            highlightedIndex = -1; // Reset the highlighted index
            populateDropdown(filteredCities);
            dropdown.classList.remove("hidden");
          });

          button.addEventListener("click", () => {
            if (dropdown.classList.contains("hidden")) {
              populateDropdown(cities); // Populate with all cities
              dropdown.classList.remove("hidden");
            } else {
              dropdown.classList.add("hidden");
            }
          });

          input.addEventListener("blur", () => {
            setTimeout(() => dropdown.classList.add("hidden"), 200); // Hide dropdown

            const value = input.value.trim();
            const isValid = cities.some(
              ({ city, country }) =>
                `${city}, ${country}`.toLowerCase() === value.toLowerCase(),
            );

            if (!isValid) {
              console.error("Invalid city on blur:", value);
              input.value = ""; // Clear invalid input
              return;
            }

            console.log("Valid city on blur:", value);

            // Trigger HTMX-compatible "change" event
            input.dispatchEvent(new Event("change", { bubbles: true }));
          });

          rowCount++;
          additionalCityCount++;
          console.log("New additionalCityCount:", additionalCityCount);
          toggleDurationVisibility();
        });

      function toggleDurationVisibility() {
        // Select all elements with the class "destination-duration"
        const durationContainers = document.querySelectorAll(
          ".destination-duration",
        );

        durationContainers.forEach((durationContainer) => {
          if (additionalCityCount > 0) {
            console.log("Hiding duration-container");
            durationContainer.style.display = "none";
          } else {
            console.log("Showing duration-container");
            durationContainer.style.display = "block";
          }
        });
      }

      function openModal(cityName) {
        const modal = document.getElementById(`modal-${cityName}`);
        if (modal) {
          modal.style.display = "flex";
        }
      }

      function closeModal(destinationCity) {
        const modal = document.getElementById(`modal-${destinationCity}`);
        if (modal) {
          modal.style.display = "none";
        }
      }

      function closeModalOnOutsideClick(event, destinationCity) {
        const modalContent =
          event.currentTarget.querySelector(".modal-content");

        // Check if the click is outside the modal-content
        if (!modalContent.contains(event.target)) {
          closeModal(destinationCity); // Close the modal
        }
      }

      // Search bar for Origin Cities

      // JavaScript for dropdown handling

      document.addEventListener("DOMContentLoaded", () => {
        // Check if cookie for search
        const input = document.getElementById("city-search");
        const savedCity = getCookie("selectedCity");
        if (savedCity) {
          // Validate the saved city before using it
          const isValidCity = cities.some(
            ({ city }) => city.toLowerCase() === savedCity.toLowerCase(),
          );

          if (isValidCity) {
            input.value = savedCity; // Set input to the saved city from the cookie
            console.log("Loaded valid city from cookie:", savedCity);
          } else {
            console.warn("Invalid city in cookie, defaulting to Berlin.");
            input.value = "Berlin"; // Set to default value if cookie is invalid
          }
        } else {
          console.log("No cookie found, defaulting to Berlin.");
          input.value = "Berlin"; // Set to default value if no cookie exists
        }
        // Search bar inputs

        const dropdown = document.getElementById("city-list");
        const button = document.getElementById("dropdown-btn");

        let highlightedIndex = -1; // Index of the highlighted item

        function populateDropdown(filteredCities) {
          dropdown.innerHTML = ""; // Clear current list
          filteredCities.forEach(({ city, country }, index) => {
            const li = document.createElement("li");
            li.textContent = `${city}`;
            li.classList.add("dropdown-item");

            // Highlight the item if it matches the current index
            if (index === highlightedIndex) {
              li.classList.add("highlighted");
            }

            li.addEventListener("click", () => {
              input.value = li.textContent; // Set input value
              dropdown.classList.add("hidden"); // Hide dropdown

              // Set the cookie when a valid city is selected
              setCookie("selectedCity", li.textContent, 7);
              console.log(
                "Cookie set for city selected via dropdown:",
                li.textContent,
              );

              // Trigger HTMX-compatible "change" event
              input.dispatchEvent(new Event("change", { bubbles: true }));
            });

            dropdown.appendChild(li);
          });
        }

        function highlightItem(index) {
          const items = dropdown.querySelectorAll("li");
          if (items.length === 0) return;

          // Remove highlight from all items
          items.forEach((item) => item.classList.remove("highlighted"));

          // Highlight the new item
          if (index >= 0 && index < items.length) {
            items[index].classList.add("highlighted");
            highlightedIndex = index;

            // Ensure the highlighted item is visible in the dropdown
            items[index].scrollIntoView({ block: "nearest" });
          }
        }

        input.addEventListener("input", () => {
          const value = input.value.toLowerCase();
          const filteredCities = cities.filter(({ city, country }) =>
            `${city}, ${country}`.toLowerCase().includes(value),
          );
          highlightedIndex = -1; // Reset the highlighted index
          populateDropdown(filteredCities);
          dropdown.classList.remove("hidden");
        });

        input.addEventListener("keydown", (event) => {
          const items = dropdown.querySelectorAll("li");
          if (items.length === 0) return;

          if (event.key === "ArrowDown") {
            // Highlight the next item
            event.preventDefault(); // Prevent cursor movement
            highlightItem(highlightedIndex + 1);
          } else if (event.key === "ArrowUp") {
            // Highlight the previous item
            event.preventDefault(); // Prevent cursor movement
            highlightItem(highlightedIndex - 1);
          } else if (event.key === "Enter") {
            // Select the highlighted item
            event.preventDefault(); // Prevent form submission
            if (highlightedIndex >= 0 && highlightedIndex < items.length) {
              items[highlightedIndex].click(); // Simulate a click
            }
          }
        });

        button.addEventListener("click", () => {
          if (dropdown.classList.contains("hidden")) {
            populateDropdown(cities); // Populate with all cities
            dropdown.classList.remove("hidden");
          } else {
            dropdown.classList.add("hidden");
          }
        });

        input.addEventListener("blur", () => {
          const value = input.value.trim();
          const isValidCity = cities.some(
            ({ city }) => city.toLowerCase() === value.toLowerCase(),
          );

          if (isValidCity) {
            setCookie("selectedCity", value, 7); // Save only valid city
            console.log("Valid city saved:", value);
          } else {
            console.warn("Invalid city, not saving:", value);
          }
          // Trigger HTMX-compatible "change" event
          input.dispatchEvent(new Event("change", { bubbles: true }));
        });

        // Cookie Monsters
        // Fetch cities from the backend
        fetch("/city-country-pairs")
          .then((response) => response.json())
          .then((data) => {
            cities = data; // Populate cities array
            console.log("Cities loaded:", cities);

            // Validate and load the selectedCity cookie
            const savedCity = getCookie("selectedCity");
            if (savedCity) {
              const isValidCity = cities.some(
                ({ city }) => city.toLowerCase() === savedCity.toLowerCase(),
              );

              if (isValidCity) {
                input.value = savedCity;
                console.log("Loaded valid city from cookie:", savedCity);
              } else {
                console.warn("Invalid city in cookie, defaulting to Berlin.");
                input.value = "Berlin";
              }
            } else {
              console.log("No cookie found, defaulting to Berlin.");
              input.value = "Berlin";
            }

            // Populate dropdown with initial cities
            populateDropdown(cities);
          })
          .catch((error) => console.error("Error loading cities:", error));

        function setCookie(name, value, days) {
          const date = new Date();
          date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
          const expires = "expires=" + date.toUTCString();
          const cookieString = `${name}=${value}; ${expires}; path=/`;
          console.log("Setting cookie:", cookieString); // Debug log
          document.cookie = cookieString;
        }

        function getCookie(name) {
          console.log("Checking for cookie:", name); // Debug log
          const cookies = document.cookie.split("; ");
          console.log("All cookies:", cookies); // Debug log

          for (let i = 0; i < cookies.length; i++) {
            const [cookieName, cookieValue] = cookies[i].split("=");
            console.log("Checking cookie:", cookieName, cookieValue); // Debug log
            if (cookieName === name) {
              return cookieValue;
            }
          }
          return null; // Return null if not found
        }
      });
    </script>
  </body>
</html>
